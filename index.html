<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Shopify Analytics Dashboard</h1>

    <!-- Tenant Selection -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Store:</label>
        <select id="tenantSelect" class="px-3 py-2 border border-gray-300 rounded-md w-full max-w-sm">
            <option value="">Loading...</option>
        </select>
        <div class="mt-4 space-x-2">
            <button id="syncAll" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Sync All Data</button>
            <button id="refreshData" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Refresh Dashboard</button>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700">Total Customers</h3>
            <p id="totalCustomers" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700">Total Orders</h3>
            <p id="totalOrders" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700">Total Products</h3>
            <p id="totalProducts" class="text-3xl font-bold text-purple-600">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700">Total Revenue</h3>
            <p id="totalRevenue" class="text-3xl font-bold text-orange-600">₹0</p>
        </div>
    </div>

    <!-- Top Customers Table -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Top Customers</h3>
        <div id="customersTable">No data available</div>
    </div>
</div>

<script>
    const API_BASE = 'https://your-app.onrender.com/api';

    let selectedTenant = '';

    // Load tenants on page load
    window.addEventListener('DOMContentLoaded', loadTenants);

    async function loadTenants() {
        try {
            const response = await fetch(`${API_BASE}/tenants`);
            const tenants = await response.json();

            const select = document.getElementById('tenantSelect');
            select.innerHTML = '<option value="">Select a tenant...</option>';

            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.tenantId;
                option.textContent = `${tenant.storeName} (${tenant.shopDomain})`;
                select.appendChild(option);
            });

            if (tenants.length > 0) {
                select.value = tenants[0].tenantId;
                selectedTenant = tenants[0].tenantId;
                loadDashboardData();
            }
        } catch (error) {
            console.error('Error loading tenants:', error);
        }
    }

    // Handle tenant selection change
    document.getElementById('tenantSelect').addEventListener('change', (e) => {
        selectedTenant = e.target.value;
        if (selectedTenant) {
            loadDashboardData();
        }
    });

    // Sync all data
    document.getElementById('syncAll').addEventListener('click', async () => {
        if (!selectedTenant) return;

        try {
            const response = await fetch(`${API_BASE}/sync/${selectedTenant}/all`, {
                method: 'POST'
            });
            const result = await response.text();
            alert(result);

            // Refresh data after 3 seconds
            setTimeout(loadDashboardData, 3000);
        } catch (error) {
            console.error('Error syncing data:', error);
            alert('Failed to sync data');
        }
    });

    // Refresh dashboard
    document.getElementById('refreshData').addEventListener('click', loadDashboardData);

    async function loadDashboardData() {
        if (!selectedTenant) return;

        try {
            // Load overview metrics
            const overviewResponse = await fetch(`${API_BASE}/analytics/${selectedTenant}/overview`);
            const overview = await overviewResponse.json();

            document.getElementById('totalCustomers').textContent = overview.totalCustomers || 0;
            document.getElementById('totalOrders').textContent = overview.totalOrders || 0;
            document.getElementById('totalProducts').textContent = overview.totalProducts || 0;
            document.getElementById('totalRevenue').textContent = `₹${overview.totalRevenue || 0}`;

            // Load top customers
            const customersResponse = await fetch(`${API_BASE}/analytics/${selectedTenant}/customers/top?limit=5`);
            const customers = await customersResponse.json();

            const customersTable = document.getElementById('customersTable');
            if (customers.length > 0) {
                let tableHTML = `
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Spent</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Orders</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;

                customers.forEach(customer => {
                    tableHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer[1]}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer[2]}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">₹${customer[3]}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer[4]}</td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                customersTable.innerHTML = tableHTML;
            } else {
                customersTable.innerHTML = '<p class="text-gray-500">No customer data available</p>';
            }

        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }
</script>
</body>
</html>
